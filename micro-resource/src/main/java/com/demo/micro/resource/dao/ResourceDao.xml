<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <!--命名空间，指定对应的Dao-->
    <mapper namespace="com.demo.micro.resource.dao.ResourceDao">
    
    <select id="selectInfoType" resultType="InfoType">
    	select * from r_info_type
    </select>
    
    <delete id="deleteSubscription" >
    	delete from r_subscription where id = #{id}
    </delete>
    
    <insert id="insertSubscription" parameterType="Subscription" useGeneratedKeys="true" keyProperty="id">
    	insert into 
    		r_subscription(user_id, info_id, status, create_date)
    	value(#{userId}, #{infoId}, #{status}, NOW())
    </insert>
    
    <select id="countSubscriptionByConditions" resultType="Long">
    	SELECT COUNT(1) 
    	FROM r_subscription
    	<where>
    		<if test="queryParams != null">
	    		<if test="queryParams.infoId != null and queryParams.infoId != ''">
	    			AND info_id = #{queryParams.infoId}
	    		</if>
	    		<if test="queryParams.userId != null and queryParams.userId != ''">
	    			AND user_id = #{queryParams.userId}
	    		</if>
	    		<if test="queryParams.status != null and queryParams.status != ''">
	    			AND status = #{queryParams.status}
	    		</if>
    		</if>
    	</where>
    </select>
    
    <select id="pageSubscription" resultType="Subscription">
    	SELECT s.*, i.info_title AS 'infoTitle' 
    	FROM r_subscription s LEFT JOIN r_info i ON s.info_id = i.id  
    	<where>
    		<if test="queryParams != null">
	    		<if test="queryParams.infoId != null and queryParams.infoId != ''">
	    			AND s.info_id = #{queryParams.infoId}
	    		</if>
	    		<if test="queryParams.userId != null and queryParams.userId != ''">
	    			AND s.user_id = #{queryParams.userId}
	    		</if>
	    		<if test="queryParams.status != null and queryParams.status != ''">
	    			AND s.status = #{queryParams.status}
	    		</if>
    		</if>
    	</where>
    	limit #{pageParams.startRow}, #{pageParams.limit}
    </select>
    
    <select id="countCommentByConditions" resultType="Long">
    	SELECT COUNT(1) 
    	FROM r_comment 
    	<where>
    		<if test="queryParams != null">
	    		<if test="queryParams.infoId != null and queryParams.infoId != ''">
	    			AND info_id = #{queryParams.infoId}
	    		</if>
	    		<if test="queryParams.userId != null and queryParams.userId != ''">
	    			AND user_id = #{queryParams.userId}
	    		</if>
    		</if>
    	</where>
    </select>
    
    <select id="pageComment" resultType="Comment">
    	SELECT c.*, u.username AS 'username', u.real_name AS 'realName' 
    	FROM r_comment c LEFT JOIN r_user u ON c.user_id = u.id
    	<where>
    		<if test="queryParams != null">
	    		<if test="queryParams.infoId != null and queryParams.infoId != ''">
	    			AND c.info_id = #{queryParams.infoId}
	    		</if>
	    		<if test="queryParams.userId != null and queryParams.userId != ''">
	    			AND c.user_id = #{queryParams.userId}
	    		</if>
    		</if>
    	</where>
    	limit #{pageParams.startRow}, #{pageParams.limit}
    </select>
    
    <delete id="deleteComment" parameterType="Long">
    	delete from r_comment where id= #{id}
    </delete>
    
    <insert id="insertComment" parameterType="Comment" useGeneratedKeys="true" keyProperty="id">
    	insert into 
    		r_comment(info_id, user_id, comm_detail, create_date)
    	value(#{infoId}, #{userId}, #{commDetail, jdbcType=BLOB}, NOW())
    </insert>
    
	<delete id="deleteInfoById" >
		delete from r_info where id = #{id}
	</delete>
    
    <select id="selectInfoById" parameterType="Long" resultType="Info">
    	select * from r_info where id = #{id}
    </select>
    
    <insert id="insertInfo" parameterType="Info" useGeneratedKeys="true" keyProperty="id">
    	insert into
    		r_info(info_title, info_detail, location_x, location_y, type_id, is_single, create_date, user_id)
    	value(
    		#{infoTitle}, 
    		#{infoDetail,jdbcType=BLOB}, 
    		#{locationX}, 
    		#{locationY}, 
    		#{typeId}, 
    		#{isSingle}, 
    		NOW(),
    		#{userId}
    	)
    </insert>
    
    <select id="countInfoByConditions" resultType="Long">
    	SELECT COUNT(1) 
    	FROM r_info
    	<where>
    		<if test="queryParams != null">
	    		<if test="queryParams.title != null and queryParams.title != ''">
	    			AND info_title LIKE (CONCAT('%',#{queryParams.title},'%'))
	    		</if>
	    		<if test="queryParams.infoType != null and queryParams.infoType != '' and queryParams.infoType != 0">
	    			AND type_id = #{queryParams.infoType}
	    		</if>
	    		<if test="queryParams.userId != null and queryParams.userId != '' and queryParams.userId != 0">
	    			AND user_id = #{queryParams.userId}
	    		</if>
    		</if>
    	</where>
    </select>
    
    <select id="pageInfo" resultType="Info">
    	SELECT * 
    	FROM r_info
    	<where>
    		<if test="queryParams != null">
	    		<if test="queryParams.title != null and queryParams.title != ''">
	    			AND info_title LIKE (CONCAT('%',#{queryParams.title},'%'))
	    		</if>
	    		<if test="queryParams.infoType != null and queryParams.infoType != '' and queryParams.infoType != 0">
	    			AND type_id = #{queryParams.infoType}
	    		</if>
	    		<if test="queryParams.userId != null and queryParams.userId != '' and queryParams.userId != 0">
	    			AND user_id = #{queryParams.userId}
	    		</if>
    		</if>
    	</where>
    	limit #{pageParams.startRow}, #{pageParams.limit}
    </select>
    
	<select id="selectRangeInfo" resultType="Info">
        SELECT *
        FROM r_info
        WHERE location_x > #{x} - #{range}
        AND location_y > #{y} - #{range}
        AND location_x &lt; #{x} + #{range}
        AND location_y &lt; #{y} + #{range}
        <if test="title != null and title != ''" >
            AND info_title LIKE (CONCAT('%',#{title},'%'))
        </if>
        <if test="infoType != null and infoType != '' and queryParams.infoType != 0" >
            AND type_id = #{infoType}
          </if>
        ORDER BY id DESC
        LIMIT 0, #{number}
    </select>
	
	<select id="findUserByUsername" resultType="UserInfo">
        SELECT * FROM r_user WHERE username = #{username}
    </select>
    
    <select id="findRoleById" resultType="Role">
        SELECT * FROM r_role WHERE id = #{id}
    </select>
</mapper>